name: å‘å¸ƒåˆ° PyPI å’Œ GitHub Release

on:
  push:
    tags:
      - "v*" # å½“æ¨é€ v å¼€å¤´çš„ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

jobs:
  release:
    runs-on: ubuntu-latest
    environment:
      name: pypi
    permissions:
      id-token: write
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: è®¾ç½® Python
        run: uv python install 3.12

      - name: è·å– tag ç‰ˆæœ¬
        id: get_version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: éªŒè¯ç‰ˆæœ¬å·åŒ¹é…
        run: |
          PROJECT_VERSION=$(uv version --short)
          if [ "$PROJECT_VERSION" != "${{ steps.get_version.outputs.VERSION }}" ]; then
            echo "é”™è¯¯: pyproject.toml ä¸­çš„ç‰ˆæœ¬ ($PROJECT_VERSION) ä¸ tag ç‰ˆæœ¬ (${{ steps.get_version.outputs.VERSION }}) ä¸åŒ¹é…"
            exit 1
          fi
          echo "ç‰ˆæœ¬éªŒè¯é€šè¿‡: $PROJECT_VERSION"

      - name: æ„å»ºåŒ…
        run: uv build

      - name: å‘å¸ƒåˆ° PyPI
        run: uv publish

      # - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
      #   id: changelog
      #   run: |
      #     # è·å–ä¸Šä¸€ä¸ª tag
      #     PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -A1 "${{ steps.get_version.outputs.TAG }}" | tail -n1)

      #     # å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ª tagï¼Œä½¿ç”¨ç¬¬ä¸€æ¬¡æäº¤
      #     if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" = "${{ steps.get_version.outputs.TAG }}" ]; then
      #       PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
      #     fi

      #     # ç”Ÿæˆå˜æ›´æ—¥å¿—
      #     CHANGELOG=$(git log $PREVIOUS_TAG..${{ steps.get_version.outputs.TAG }} --pretty=format:"- %s (%h)" --no-merges)

      #     # ä¿å­˜åˆ°æ–‡ä»¶
      #     echo "## å˜æ›´å†…å®¹" > CHANGELOG.md
      #     echo "" >> CHANGELOG.md
      #     echo "$CHANGELOG" >> CHANGELOG.md

      #     # å¦‚æœå˜æ›´æ—¥å¿—ä¸ºç©ºï¼Œæ·»åŠ é»˜è®¤å†…å®¹
      #     if [ -z "$CHANGELOG" ]; then
      #       echo "- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ" >> CHANGELOG.md
      #     fi

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.get_version.outputs.TAG }}
          # body_path: CHANGELOG.md
          files: dist/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
        run: |
          echo "âœ… æˆåŠŸå‘å¸ƒç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }}"
          echo "ğŸ“¦ PyPI: https://pypi.org/project/seerapi/${{ steps.get_version.outputs.VERSION }}/"
          echo "ğŸ‰ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.TAG }}"
